{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <!-- Hero Section -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="text-center mb-5 animate-on-scroll">
                <h1 class="display-4 fw-bold mb-3">Professional Freelancing Services</h1>
                <p class="lead fs-5 mb-4 text-primary">Expert solutions tailored to your business needs</p>
                <p class="fs-6">
                    I offer high-quality freelancing services in AI Development, Data Science, and Web Development. 
                    With years of experience and a commitment to excellence, I deliver results that exceed expectations.
                </p>
            </div>
        </div>
    </div>

    <!-- Services Grid -->
    <div class="row">
        {% for service in services %}
        <div class="col-md-6 col-lg-3 mb-4 animate-on-scroll">
            <div class="card h-100 border-0 shadow-sm service-card">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 70px; height: 70px;">
                        <i class="{{ service.icon_class }} fa-2x"></i>
                    </div>
                    <h5 class="card-title">{{ service.name }}</h5>
                    <p class="card-text">{{ service.description|truncatewords:20 }}</p>
                    {% if service.price %}
                    <div class="mt-3">
                        <span class="fw-bold text-primary fs-5">${{ service.price }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent border-0 text-center">
                    <button class="btn btn-primary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#bookingModal" data-service="{{ service.name }}">
                        <i class="fas fa-calendar-check me-1"></i> Book Now
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Process Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="section-title text-center animate-on-scroll">
                <h2><i class="fas fa-cogs me-2"></i> My Process</h2>
                <div class="divider mx-auto"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3 mb-4 animate-on-scroll">
            <div class="card border-0 shadow-sm h-100 feature-card">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-comments fa-lg"></i>
                    </div>
                    <h5>Consultation</h5>
                    <p class="mb-0">We discuss your requirements and goals to understand your needs.</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4 animate-on-scroll">
            <div class="card border-0 shadow-sm h-100 feature-card">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-pencil-alt fa-lg"></i>
                    </div>
                    <h5>Planning</h5>
                    <p class="mb-0">I create a detailed plan and timeline for your project.</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4 animate-on-scroll">
            <div class="card border-0 shadow-sm h-100 feature-card">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-laptop-code fa-lg"></i>
                    </div>
                    <h5>Development</h5>
                    <p class="mb-0">I build your solution with regular updates and feedback.</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4 animate-on-scroll">
            <div class="card border-0 shadow-sm h-100 feature-card">
                <div class="card-body text-center">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-rocket fa-lg"></i>
                    </div>
                    <h5>Delivery</h5>
                    <p class="mb-0">I deliver the final product with documentation and support.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CTA Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient-primary text-white animate-on-scroll">
                <div class="card-body text-center p-5">
                    <h2 class="card-title text-white">
                        <i class="fas fa-headset me-2"></i> Ready to Get Started?
                    </h2>
                    <div class="divider mx-auto bg-white"></div>
                    <p class="card-text lead mb-4">
                        Schedule a free consultation to discuss your project requirements and how I can help you achieve your goals.
                    </p>
                    <div class="d-flex flex-wrap justify-content-center gap-3">
                        <button class="btn btn-light btn-lg px-4 py-3" data-bs-toggle="modal" data-bs-target="#bookingModal">
                            <i class="fas fa-calendar-check me-2"></i> Book a Consultation
                        </button>
                        <a href="{% url 'contact' %}" class="btn btn-outline-light btn-lg px-4 py-3">
                            <i class="fas fa-envelope me-2"></i> Send a Message
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <!-- Toast will be dynamically inserted here -->
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel"><i class="fas fa-calendar-check me-2"></i> Book an Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" novalidate>
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bookingName" class="form-label">Full Name *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                <input type="text" class="form-control" id="bookingName" required>
                                <div class="invalid-feedback">Please enter your name.</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="bookingEmail" class="form-label">Email Address *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-at"></i></span>
                                <input type="email" class="form-control" id="bookingEmail" required>
                                <div class="invalid-feedback">Please enter a valid email address.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bookingPhone" class="form-label">Phone Number</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                <input type="tel" class="form-control" id="bookingPhone">
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="bookingService" class="form-label">Service *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-briefcase"></i></span>
                                <select class="form-select" id="bookingService" required>
                                    <option value="">Select a service</option>
                                    {% for s in services %}
                                    <option value="{{ s.name }}">{{ s.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a service.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bookingDate" class="form-label">Preferred Date *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                <input type="date" class="form-control" id="bookingDate" required>
                                <div class="invalid-feedback">Please select a date.</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="bookingTime" class="form-label">Preferred Time *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                <select class="form-select" id="bookingTime" required>
                                    <option value="">Select a time</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">01:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="17:00">05:00 PM</option>
                                </select>
                                <div class="invalid-feedback">Please select a time.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bookingMessage" class="form-label">Project Details *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-comment"></i></span>
                            <textarea class="form-control" id="bookingMessage" rows="3" placeholder="Please describe your project requirements in detail..." required></textarea>
                            <div class="invalid-feedback">Please provide project details.</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bookingBudget" class="form-label">Estimated Budget (Optional)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                            <input type="number" class="form-control" id="bookingBudget" placeholder="Enter your budget range">
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane me-2"></i> Schedule Appointment
                        </button>
                    </div>
                </form>
                
                <div id="bookingSuccess" class="alert alert-success mt-3 d-none" role="alert">
                    <i class="fas fa-check-circle me-2"></i> Your appointment has been scheduled successfully! I'll contact you soon to confirm.
                </div>
                
                <div id="bookingError" class="alert alert-danger mt-3 d-none" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i> There was an error scheduling your appointment. Please try again.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set min date for booking form
        const today = new Date();
        const minDate = new Date(today);
        minDate.setDate(today.getDate() + 1);
        document.getElementById('bookingDate').min = minDate.toISOString().split('T')[0];
        
        // Handle service selection from cards
        const bookButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-service]');
        bookButtons.forEach(button => {
            button.addEventListener('click', function() {
                const serviceName = this.getAttribute('data-service');
                if (serviceName) {
                    document.getElementById('bookingService').value = serviceName;
                }
            });
        });
        
        // Handle booking form submission
        const bookingForm = document.getElementById('bookingForm');
        const bookingSuccess = document.getElementById('bookingSuccess');
        const bookingError = document.getElementById('bookingError');
        
        // Function to create toast notifications
        function createBookingToast(type, message) {
            const toastContainer = document.querySelector('.toast-container');
            
            // Create toast element
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center border-0 text-white bg-${type === 'success' ? 'success' : 'danger'}`;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastEl);
            
            // Initialize and show toast
            const toast = new bootstrap.Toast(toastEl, {
                delay: 5000
            });
            toast.show();
            
            // Remove toast from DOM after it's hidden
            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        }
        
        bookingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check form validity
            if (!bookingForm.checkValidity()) {
                e.stopPropagation();
                bookingForm.classList.add('was-validated');
                return;
            }
            
            // Get form data
            const formData = {
                name: document.getElementById('bookingName').value,
                email: document.getElementById('bookingEmail').value,
                phone: document.getElementById('bookingPhone').value,
                service: document.getElementById('bookingService').value,
                date: document.getElementById('bookingDate').value,
                time: document.getElementById('bookingTime').value,
                message: document.getElementById('bookingMessage').value,
                budget: document.getElementById('bookingBudget').value || null
            };
            
            // Get CSRF token from the form
            const csrfTokenElement = document.querySelector('#bookingForm [name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                console.error('CSRF token not found');
                bookingError.textContent = 'Form security token missing. Please refresh the page and try again.';
                bookingError.classList.remove('d-none');
                return;
            }
            const csrfToken = csrfTokenElement.value;
            
            // Send AJAX request
            fetch('{% url "booking_submit" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    bookingSuccess.textContent = data.message;
                    bookingSuccess.classList.remove('d-none');
                    bookingError.classList.add('d-none');
                    
                    // Trigger Google Ads conversion tracking
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'conversion', {
                            'send_to': 'AW-17673705659/ThWNCN3U7MQbELuxvetB',
                            'value': 1.0,
                            'currency': 'INR'
                        });
                    }
                    
                    // Reset form
                    bookingForm.reset();
                    bookingForm.classList.remove('was-validated');
                    
                    // Hide modal after 3 seconds but keep success message visible on page
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
                        // Create a toast notification for persistent success message
                        createBookingToast('success', data.message);
                    }, 3000);
                } else {
                    // Show error message
                    bookingError.textContent = data.message;
                    bookingError.classList.remove('d-none');
                    bookingSuccess.classList.add('d-none');
                    
                    // Create error toast
                    createBookingToast('error', data.message);
                }
            })
            .catch(error => {
                console.error('Booking error:', error);
                // Show error message
                bookingError.textContent = 'An error occurred while processing your booking. Please try again.';
                bookingError.classList.remove('d-none');
                bookingSuccess.classList.add('d-none');
                
                // Create error toast
                createBookingToast('error', 'An error occurred while processing your booking. Please try again.');
            });
        });
    });
</script>
{% endblock %}