<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel"><i class="fas fa-calendar-check me-2"></i> Book an Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" novalidate>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bookingName" class="form-label">Full Name *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                <input type="text" class="form-control" id="bookingName" required>
                                <div class="invalid-feedback">Please enter your name.</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="bookingEmail" class="form-label">Email Address *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-at"></i></span>
                                <input type="email" class="form-control" id="bookingEmail" required>
                                <div class="invalid-feedback">Please enter a valid email address.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bookingPhone" class="form-label">Phone Number</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                <input type="tel" class="form-control" id="bookingPhone">
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="bookingService" class="form-label">Service *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-briefcase"></i></span>
                                <select class="form-select" id="bookingService" required>
                                    <option value="">Select a service</option>
                                    {% for s in services %}
                                    <option value="{{ s.name }}">{{ s.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a service.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bookingDate" class="form-label">Preferred Date *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                <input type="date" class="form-control" id="bookingDate" required>
                                <div class="invalid-feedback">Please select a date.</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="bookingTime" class="form-label">Preferred Time *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                <select class="form-select" id="bookingTime" required>
                                    <option value="">Select a time</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">01:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="17:00">05:00 PM</option>
                                </select>
                                <div class="invalid-feedback">Please select a time.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bookingMessage" class="form-label">Project Details *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-comment"></i></span>
                            <textarea class="form-control" id="bookingMessage" rows="3" placeholder="Please describe your project requirements in detail..." required></textarea>
                            <div class="invalid-feedback">Please provide project details.</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bookingBudget" class="form-label">Estimated Budget (Optional)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                            <input type="number" class="form-control" id="bookingBudget" placeholder="Enter your budget range">
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-calendar-check me-2"></i> Schedule Appointment
                        </button>
                    </div>
                </form>
                
                <div id="bookingSuccess" class="alert alert-success mt-3 d-none" role="alert">
                    <i class="fas fa-check-circle me-2"></i> Your appointment has been scheduled successfully! I'll contact you soon to confirm.
                </div>
                
                <div id="bookingError" class="alert alert-danger mt-3 d-none" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i> There was an error scheduling your appointment. Please try again.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set min date for booking form
        const today = new Date();
        const minDate = new Date(today);
        minDate.setDate(today.getDate() + 1);
        document.getElementById('bookingDate').min = minDate.toISOString().split('T')[0];
        
        // Handle service selection from cards
        const bookButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-service]');
        bookButtons.forEach(button => {
            button.addEventListener('click', function() {
                const serviceName = this.getAttribute('data-service');
                if (serviceName) {
                    document.getElementById('bookingService').value = serviceName;
                }
            });
        });
        
        // Handle booking form submission
        const bookingForm = document.getElementById('bookingForm');
        const bookingSuccess = document.getElementById('bookingSuccess');
        const bookingError = document.getElementById('bookingError');
        
        bookingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check form validity
            if (!bookingForm.checkValidity()) {
                e.stopPropagation();
                bookingForm.classList.add('was-validated');
                return;
            }
            
            // Get form data
            const formData = {
                name: document.getElementById('bookingName').value,
                email: document.getElementById('bookingEmail').value,
                phone: document.getElementById('bookingPhone').value,
                service: document.getElementById('bookingService').value,
                date: document.getElementById('bookingDate').value,
                time: document.getElementById('bookingTime').value,
                message: document.getElementById('bookingMessage').value,
                budget: document.getElementById('bookingBudget').value || null
            };
            
            // Send AJAX request
            fetch('{% url "booking_submit" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    bookingSuccess.classList.remove('d-none');
                    bookingError.classList.add('d-none');
                    
                    // Reset form
                    bookingForm.reset();
                    bookingForm.classList.remove('was-validated');
                    
                    // Hide success message and modal after 3 seconds
                    setTimeout(() => {
                        bookingSuccess.classList.add('d-none');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                        modal.hide();
                    }, 3000);
                } else {
                    // Show error message
                    bookingError.textContent = data.message;
                    bookingError.classList.remove('d-none');
                    bookingSuccess.classList.add('d-none');
                }
            })
            .catch(error => {
                // Show error message
                bookingError.textContent = 'An error occurred. Please try again.';
                bookingError.classList.remove('d-none');
                bookingSuccess.classList.add('d-none');
            });
        });
        
        // CSRF token helper function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>